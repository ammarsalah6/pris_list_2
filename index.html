<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>قائمة الأسعار - المكسرات والحلويات</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            /* ألوان مستوحاة من اللوجو ومنتجات المكسرات/القهوة */
            --primary-dark: #3E2723;   /* بني غامق */
            --primary-light: #5D4037;  /* بني متوسط */
            --accent-gold: #C67C00;    /* ذهبي (للأسعار والتمييز) */
            --bg-cream: #FFF8E1;       /* كريمي (خلفية الورق) */
            --text-main: #212121;      /* لون الخط الرئيسي */
            --border-color: #D7CCC8;   /* لون الحدود الفاتح */
            /* مقاسات ثابتة لصفحة الكتاب */
            --page-height: 480px; 
            --page-padding: 30px;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #ECEFF1;
            background-image: url("https://www.transparenttextures.com/patterns/cream-paper.png");
            margin: 0;
            padding: 0;
            color: var(--text-main);
        }

        /* حاوية المنيو (شكل الكتاب) */
        .menu-book {
            max-width: 900px;
            margin: 40px auto 100px auto;
            background-color: var(--bg-cream);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            border-left: 1px solid #ccc;
            border-right: 12px solid var(--primary-dark); /* كعب الكتاب */
        }

        /* رأس الصفحة واللوجو */
        header {
            text-align: center;
            padding: 30px 20px 20px;
            background: linear-gradient(to bottom, #fff, var(--bg-cream));
            border-bottom: 2px dashed var(--primary-light);
        }

        .logo-container img {
            max-width: 150px;
            height: auto;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
            margin-bottom: 10px;
        }

        header h1 {
            font-family: 'Amiri', serif;
            font-size: 2.2rem;
            color: var(--primary-dark);
            margin: 5px 0;
        }

        /* مربع البحث */
        .search-container {
            position: sticky;
            top: 0;
            background: var(--bg-cream);
            padding: 10px 30px;
            z-index: 10;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: center;
        }
        
        /* ---------------------------------
        * تنسيق الصفحات (مقاس واحد)
        * --------------------------------- */
        #page-content {
            padding: var(--page-padding);
            height: var(--page-height); /* ارتفاع ثابت للصفحة الواحدة */
            overflow: hidden; /* إخفاء أي محتوى يتجاوز الارتفاع الثابت */
            position: relative;
        }

        /* تنسيق الأقسام */
        .category-section {
            margin-bottom: 20px;
        }

        .category-title {
            font-family: 'Amiri', serif;
            font-size: 1.8rem;
            color: var(--primary-dark);
            border-bottom: 2px solid var(--accent-gold);
            display: inline-block;
            margin-bottom: 15px;
            padding-bottom: 5px;
        }

        /* تنسيق الأصناف */
        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            transition: max-height 0.5s ease-out; /* حركة فتح وغلق "عرض المزيد" */
        }

        .menu-item {
            background: #fff;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .item-name {
            font-weight: 500;
            font-size: 1rem;
            color: var(--text-main);
        }

        .item-price {
            font-family: 'Amiri', serif;
            font-weight: bold;
            font-size: 1.2rem;
            background-color: var(--bg-cream);
            padding: 4px 10px;
            border-radius: 15px;
            border: 1px solid var(--border-color);
            color: var(--primary-dark);
            white-space: nowrap;
            margin-right: 10px;
        }
        
        /* زر عرض المزيد/أقل داخل الصفحة */
        .toggle-btn {
            width: 100%;
            padding: 10px;
            margin-top: 15px;
            border: none;
            background-color: var(--primary-light);
            color: #fff;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Tajawal', sans-serif;
            font-size: 1rem;
            transition: background-color 0.3s;
        }

        .toggle-btn:hover {
            background-color: var(--accent-gold);
        }
        
        /* ---------------------------------
        * شريط التنقل بين الصفحات
        * --------------------------------- */
        .pagination-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            background-color: var(--primary-dark);
            color: #fff;
            font-family: 'Tajawal', sans-serif;
            user-select: none;
            position: sticky;
            bottom: 0;
            z-index: 50;
        }

        .nav-btn {
            background-color: var(--primary-light);
            color: #fff;
            padding: 10px 20px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 700;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
        }

        .nav-btn:hover:not(:disabled) {
            background-color: var(--accent-gold);
        }

        .nav-btn:disabled {
            background-color: #5D403750;
            cursor: not-allowed;
            color: #ccc;
        }

        .nav-btn i {
            margin: 0 5px;
        }
        
        .page-info {
            font-size: 1.1rem;
            font-weight: 500;
            text-align: center;
        }

        /* رسائل التحميل والخطأ */
        .loader, .error-msg {
            text-align: center;
            font-size: 1.2rem;
            color: var(--primary-light);
            margin-top: 50px;
        }
        
        .error-msg {
            color: #d32f2f;
            background: #ffebee;
            padding: 15px;
            border-radius: 5px;
            margin: 20px;
        }

        /* شريط السوشيال ميديا */
        .social-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--primary-dark);
            padding: 15px;
            text-align: center;
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
            display: none; /* إخفائه هنا لأنه تداخل مع شريط التنقل الجديد */
        }
        
        /* التجاوب مع الموبايل */
        @media (max-width: 600px) {
            :root {
                --page-height: 55vh; /* ارتفاع بالنظر إلى مساحة الشاشة */
                --page-padding: 20px;
            }
            .menu-book {
                margin: 0;
                border-right: none;
                border-radius: 0;
                width: 100%;
            }
            .items-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <div class="menu-book">
        <header>
            <div class="logo-container">
                <img src="logo.png" alt="شعار المحل" onerror="this.style.display='none'">
            </div>
            <h1>قائمة الأصناف</h1>
            <p>أجود الأنواع وأفضل الأسعار</p>
        </header>

        <div class="search-container">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="ابحث عن صنف...">
            </div>
        </div>

        <div id="page-content">
            <div class="loader">
                <i class="fas fa-spinner fa-spin"></i> جاري تحميل القائمة...
            </div>
        </div>
        
        <div class="pagination-nav">
            <button id="prevBtn" class="nav-btn" disabled>
                <i class="fas fa-chevron-right"></i> السابق
            </button>
            
            <div id="pageInfo" class="page-info"></div>

            <button id="nextBtn" class="nav-btn" disabled>
                التالي <i class="fas fa-chevron-left"></i>
            </button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <script>
        // **********************************************************
        // هام جداً: ضع رابط الجوجل شيت CSV هنا
        // **********************************************************
        const sheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRgbYRoL8GGwdIFjwzWvtNh43_ylOoYDRCst4i-pJUjPOwT813rVkCCGeoYFKfSPnXcHBAb094Z1SF8/pub?gid=1174703353&single=true&output=csv';

        const pageContent = document.getElementById('page-content');
        const searchInput = document.getElementById('searchInput');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const pageInfo = document.getElementById('pageInfo');
        
        let allData = []; // البيانات الخام
        let allCategories = []; // قائمة ببيانات التصنيفات المجمعة
        let currentPageIndex = 0; // مؤشر الصفحة الحالية
        const ITEMS_PER_PREVIEW = 10; // عدد الأصناف التي تظهر قبل زر "عرض المزيد"

        // دالة مساعدة للعثور على اسم المفتاح الصحيح (العنوان) بغض النظر عن المسافات الزائدة
        function findKey(item, target) {
            for (const key in item) {
                if (key && key.trim() === target) {
                    return key;
                }
            }
            return null;
        }
        
        // ------------------------------------------------
        // 1. معالجة البيانات وتحميلها
        // ------------------------------------------------

        function processData(data) {
            const categoriesMap = {};
            
            data.forEach(item => {
                const categoryKey = findKey(item, 'التصنيف');
                const nameKey = findKey(item, 'الصنف');
                const priceKey = findKey(item, 'السعر');

                const category = categoryKey ? item[categoryKey] : null;
                const name = nameKey ? item[nameKey] : null;
                const price = priceKey ? item[priceKey] : null;

                if (category && category.trim() !== '' && name && name.trim() !== '') {
                    const cleanCat = category.trim();
                    if (!categoriesMap[cleanCat]) {
                        categoriesMap[cleanCat] = [];
                    }
                    categoriesMap[cleanCat].push({ name: name.trim(), price: price ? price.trim() : null });
                }
            });

            // تحويل الخريطة إلى قائمة صفحات
            allCategories = Object.keys(categoriesMap).map(catName => ({
                categoryName: catName,
                items: categoriesMap[catName]
            }));
            
            // فلترة القائمة لإزالة أي تصنيفات فارغة قد تكون تكونت
            allCategories = allCategories.filter(cat => cat.items.length > 0);
        }

        function fetchMenu() {
            if (sheetURL.includes("ضع_رابط")) {
                pageContent.innerHTML = `<div class="error-msg">الرجاء وضع رابط CSV الخاص بجوجل شيت في الكود.</div>`;
                return;
            }

            Papa.parse(sheetURL, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    allData = results.data;
                    processData(allData);
                    
                    if (allCategories.length > 0) {
                        displayPage(0); // عرض الصفحة الأولى
                        setupNavigation(); // تفعيل أزرار التنقل
                    } else {
                        pageContent.innerHTML = `<div class="error-msg">لا توجد بيانات صالحة للعرض. تأكد من الأعمدة (التصنيف, الصنف, السعر).</div>`;
                        nextBtn.disabled = true;
                        prevBtn.disabled = true;
                    }
                },
                error: function(err) {
                    pageContent.innerHTML = `<div class="error-msg">حدث خطأ أثناء تحميل البيانات. تأكد من صحة الرابط أو إعدادات المشاركة.<br>${err.message}</div>`;
                }
            });
        }
        
        // ------------------------------------------------
        // 2. عرض الصفحات (التصنيفات)
        // ------------------------------------------------

        function renderCategoryContent(categoryData, isFullView = false) {
            pageContent.innerHTML = '';

            const section = document.createElement('section');
            section.className = 'category-section';

            const title = document.createElement('div');
            title.className = 'category-title';
            title.innerText = categoryData.categoryName;
            section.appendChild(title);

            const grid = document.createElement('div');
            grid.className = 'items-grid';

            const itemsToRender = isFullView ? categoryData.items : categoryData.items.slice(0, ITEMS_PER_PREVIEW);

            itemsToRender.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'menu-item';
                
                let priceDisplay = item.price ? item.price : '--';
                
                itemEl.innerHTML = `
                    <div class="item-name">${item.name}</div>
                    <div class="item-price">
                        ${priceDisplay} <span class="currency">ج.م</span>
                    </div>
                `;
                grid.appendChild(itemEl);
            });

            section.appendChild(grid);
            pageContent.appendChild(section);

            // إضافة زر "عرض المزيد/أقل"
            if (categoryData.items.length > ITEMS_PER_PREVIEW) {
                const toggleButton = document.createElement('button');
                toggleButton.className = 'toggle-btn';
                toggleButton.setAttribute('data-full-view', isFullView ? 'true' : 'false');
                toggleButton.innerText = isFullView ? 'عرض الأقل' : `عرض المزيد (${categoryData.items.length - ITEMS_PER_PREVIEW} صنف إضافي)`;
                
                toggleButton.onclick = function() {
                    // التبديل بين العرض الكامل والمختصر
                    const newFullView = this.getAttribute('data-full-view') !== 'true';
                    // إعادة عرض الصفحة الحالية بالوضع الجديد
                    renderCategoryContent(categoryData, newFullView);
                    
                    // تحريك الشاشة للأعلى لرؤية بداية الصفحة الجديدة
                    pageContent.scrollTop = 0;
                };

                pageContent.appendChild(toggleButton);
                
                // للحفاظ على مقاس الصفحة الثابت، يتم إظهار التمرير (Scrolling) فقط عند الضغط على "عرض المزيد"
                if (isFullView) {
                    pageContent.style.overflowY = 'auto'; // تفعيل التمرير
                } else {
                    pageContent.style.overflowY = 'hidden'; // إخفاء التمرير (المقاس الثابت)
                }
            } else {
                 pageContent.style.overflowY = 'hidden'; // لا يوجد زر، إخفاء التمرير
            }
        }
        
        function displayPage(index) {
            if (index >= 0 && index < allCategories.length) {
                currentPageIndex = index;
                const currentCategory = allCategories[index];
                renderCategoryContent(currentCategory, false); // عرض الصفحة بشكل مختصر في البداية
                updateNavigationUI();
            }
        }

        // ------------------------------------------------
        // 3. التنقل بين الصفحات
        // ------------------------------------------------
        
        function updateNavigationUI() {
            const totalPages = allCategories.length;
            const isLastPage = currentPageIndex === totalPages - 1;
            const isFirstPage = currentPageIndex === 0;
            
            prevBtn.disabled = isFirstPage;
            nextBtn.disabled = isLastPage;
            
            const currentCatName = allCategories[currentPageIndex].categoryName;
            pageInfo.innerHTML = `التصنيف الحالي: <strong>${currentCatName}</strong> <br> صفحة ${currentPageIndex + 1} من ${totalPages}`;

            // تحديث زر التالي باسم التصنيف التالي
            if (!isLastPage) {
                const nextCatName = allCategories[currentPageIndex + 1].categoryName;
                nextBtn.innerHTML = `التالي: ${nextCatName} <i class="fas fa-chevron-left"></i>`;
            } else {
                nextBtn.innerHTML = `النهاية <i class="fas fa-check"></i>`;
            }
        }
        
        function setupNavigation() {
            prevBtn.onclick = () => {
                if (currentPageIndex > 0) {
                    displayPage(currentPageIndex - 1);
                }
            };

            nextBtn.onclick = () => {
                if (currentPageIndex < allCategories.length - 1) {
                    displayPage(currentPageIndex + 1);
                }
            };
        }
        
        // ------------------------------------------------
        // 4. دالة البحث (تعرض جميع النتائج في صفحة واحدة مؤقتة)
        // ------------------------------------------------
        
        function handleSearch(term) {
            if (term.trim() === '') {
                // إذا كان البحث فارغاً، نعود للصفحة الحالية
                displayPage(currentPageIndex); 
                document.querySelector('.pagination-nav').style.display = 'flex';
                return;
            }
            
            const filteredData = allData.filter(item => {
                const nameKey = findKey(item, 'الصنف');
                const catKey = findKey(item, 'التصنيف');

                const nameMatch = nameKey && item[nameKey] && item[nameKey].toLowerCase().includes(term);
                const catMatch = catKey && item[catKey] && item[catKey].toLowerCase().includes(term);
                
                return nameMatch || catMatch;
            });

            // إخفاء شريط التنقل بين الصفحات أثناء البحث
            document.querySelector('.pagination-nav').style.display = 'none';

            if (filteredData.length === 0) {
                pageContent.innerHTML = `<div style="padding: 20px; text-align: center;">لا توجد نتائج مطابقة لـ "<strong>${term}</strong>"</div>`;
                return;
            }

            // تجميع نتائج البحث في تصنيف وهمي واحد للعرض
            const searchCategory = {
                categoryName: `نتائج البحث عن: "${term}"`,
                items: filteredData.map(item => {
                     const nameKey = findKey(item, 'الصنف');
                     const priceKey = findKey(item, 'السعر');
                    return { 
                        name: item[nameKey].trim(), 
                        price: item[priceKey] ? item[priceKey].trim() : null
                    };
                })
            };
            
            // عرض نتائج البحث في وضع "عرض الكل"
            renderCategoryContent(searchCategory, true);
        }

        searchInput.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            handleSearch(term);
        });

        // بدء التحميل
        fetchMenu();

    </script>
</body>
</html>